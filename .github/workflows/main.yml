name: Build and Deploy VSCode Extension

on:
  # Pull Requestì™€ Pushì‹œ ë¹Œë“œ í…ŒìŠ¤íŠ¸
  push:
    branches: [main, develop]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "20"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (íƒœê·¸ ì •ë³´ í•„ìš”)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Lint Code
        run: npm run lint || echo "Linting failed but continuing..."

      - name: Compile TypeScript
        run: npm run compile

      - name: Run Tests
        run: npm test || echo "Tests failed but continuing..."

      - name: Package Extension
        run: |
          npm install -g @vscode/vsce
          vsce package --no-dependencies

      - name: Upload VSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package-${{ github.sha }}
          path: "*.vsix"
          retention-days: 30

      - name: Check Package Contents
        run: |
          vsce ls
          echo "Package size:"
          ls -lh *.vsix

  deploy:
    # íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œë§Œ ë°°í¬ ì‹¤í–‰
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')
    needs: build
    runs-on: ubuntu-latest
    environment: production # GitHub Environment ë³´í˜¸ ì‚¬ìš©

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Compile TypeScript
        run: npm run compile

      - name: Install VSCE
        run: npm install -g @vscode/vsce

      - name: Extract Version from Tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Validate Version Format
        run: |
          if ! [[ "${{ steps.get_version.outputs.VERSION }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: ${{ steps.get_version.outputs.VERSION }}"
            echo "Expected format: x.y.z (e.g., 1.0.0)"
            exit 1
          fi

      - name: Update Package Version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          TARGET_VERSION="${{ steps.get_version.outputs.VERSION }}"

          echo "Current version: $CURRENT_VERSION"
          echo "Target version: $TARGET_VERSION"

          if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
            npm version $TARGET_VERSION --no-git-tag-version
            echo "âœ… Updated package.json version to $TARGET_VERSION"
          else
            echo "â„¹ï¸ Version is already $TARGET_VERSION, skipping update"
          fi

      - name: Verify Package Configuration
        run: |
          # publisher í•„ë“œ í™•ì¸
          PUBLISHER=$(node -p "require('./package.json').publisher")
          if [ "$PUBLISHER" = "your-publisher-name" ] || [ "$PUBLISHER" = "undefined" ]; then
            echo "âŒ Error: Please update the 'publisher' field in package.json"
            echo "Current publisher: $PUBLISHER"
            echo "Visit https://marketplace.visualstudio.com/manage to create a publisher"
            exit 1
          fi
          echo "âœ… Publisher: $PUBLISHER"

          # ê¸°ë³¸ í•„ë“œë“¤ í™•ì¸
          NAME=$(node -p "require('./package.json').name")
          DESCRIPTION=$(node -p "require('./package.json').description")
          echo "âœ… Extension: $NAME"
          echo "âœ… Description: $DESCRIPTION"

      - name: Package Extension
        run: |
          vsce package --no-dependencies
          PACKAGE_NAME=$(ls *.vsix)
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "ğŸ“¦ Created package: $PACKAGE_NAME"

      - name: Publish to VSCode Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          if [ -z "$VSCE_PAT" ]; then
            echo "âŒ Error: VSCE_PAT secret is not set"
            echo "Please add your Personal Access Token to GitHub Secrets"
            echo "Guide: https://code.visualstudio.com/api/working-with-extensions/publishing-extension#get-a-personal-access-token"
            exit 1
          fi

          echo "ğŸš€ Publishing to VSCode Marketplace..."
          vsce publish -p $VSCE_PAT --no-dependencies
          echo "âœ… Successfully published to VSCode Marketplace"

      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸš€ RTEMS QDP Builder v${{ steps.get_version.outputs.VERSION }}

          ### ğŸ“¥ ì„¤ì¹˜ ë°©ë²•

          **VSCode Marketplaceì—ì„œ ì„¤ì¹˜ (ê¶Œì¥):**
          ```bash
          code --install-extension $(node -p "require('./package.json').publisher").rtems-qdp-builder
          ```

          **ë˜ëŠ” VSIX íŒŒì¼ë¡œ ì§ì ‘ ì„¤ì¹˜:**
          1. ì•„ë˜ Assetsì—ì„œ `.vsix` íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          2. VSCodeì—ì„œ `Ctrl+Shift+P` â†’ "Extensions: Install from VSIX" ì‹¤í–‰
          3. ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ ì„ íƒ

          ### ğŸ”§ ì‚¬ìš© ë°©ë²•

          1. **í™˜ê²½ ì¤€ë¹„**: `/opt` ë””ë ‰í„°ë¦¬ì—ì„œ VSCode ì‹¤í–‰
          2. **Extension ì‹¤í–‰**: `Ctrl+Shift+P` â†’ "Open RTEMS QDP Builder"
          3. **í™˜ê²½ í™•ì¸**: "í™˜ê²½ í™•ì¸" ë²„íŠ¼ìœ¼ë¡œ RTEMS QDP í™˜ê²½ ê²€ì¦
          4. **ì„¤ì • êµ¬ì„±**: 
             - ë¹Œë“œ ë””ë ‰í„°ë¦¬ì™€ í”Œë«í¼ ì •ë³´ ì…ë ¥
             - í”„ë¦¬ì…‹ ì„ íƒ ë˜ëŠ” ê°œë³„ ë¹Œë“œ ìŠ¤í… ì„ íƒ
          5. **ë¹Œë“œ ì‹¤í–‰**: "ì„¤ì • íŒŒì¼ ìƒì„±" â†’ "ë¹Œë“œ ì‹¤í–‰"

          ### ğŸ“‹ ì£¼ìš” ê¸°ëŠ¥

          - âœ¨ **ì‚¬ìš©ì ì¹œí™”ì  UI**: ë³µì¡í•œ YAML ì„¤ì •ì„ GUIë¡œ ê°„í¸í•˜ê²Œ êµ¬ì„±
          - ğŸ¯ **ìŠ¤ë§ˆíŠ¸ í”„ë¦¬ì…‹**: ê¸°ë³¸ í”„ë¦¬ì…‹ + ì‚¬ìš©ì ì •ì˜ í”„ë¦¬ì…‹ ì €ì¥/ê´€ë¦¬
          - ğŸ“Š **40+ ë¹Œë“œ ìŠ¤í…**: 15ê°œ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì²´ê³„ì  ë¶„ë¥˜
          - ğŸ” **ìë™ í™˜ê²½ ê²€ì¦**: RTEMS QDP í™˜ê²½ êµ¬ì¡° ë° í•„ìˆ˜ íŒŒì¼ í™•ì¸
          - ğŸš€ **ì›í´ë¦­ ë¹Œë“œ**: ì„¤ì •ë¶€í„° ì‹¤í–‰ê¹Œì§€ ì™„ì „ ìë™í™”
          - ğŸ“± **ë°˜ì‘í˜• ì¸í„°í˜ì´ìŠ¤**: VSCode í…Œë§ˆ ìë™ ì ìš©

          ### ğŸ› ë¬¸ì œ ë³´ê³ 

          ë²„ê·¸ë‚˜ ê¸°ëŠ¥ ìš”ì²­ì€ [GitHub Issues](https://github.com/${{ github.repository }}/issues)ì—ì„œ ë³´ê³ í•´ì£¼ì„¸ìš”.

          ### ğŸ“š ë¬¸ì„œ

          ìì„¸í•œ ì‚¬ìš©ë²•ì€ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.get_version.outputs.VERSION }}...HEAD
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Release v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          files: ${{ env.PACKAGE_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-prerelease:
    # Pre-release ë²„ì „ ë°°í¬ (alpha, beta, rc ë“±)
    if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-')
    needs: build
    runs-on: ubuntu-latest
    environment: prerelease

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Compile TypeScript
        run: npm run compile

      - name: Install VSCE
        run: npm install -g @vscode/vsce

      - name: Extract Version from Tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying pre-release version: $VERSION"

      - name: Update Package Version
        run: |
          npm version ${{ steps.get_version.outputs.VERSION }} --no-git-tag-version

      - name: Package Extension
        run: |
          vsce package --pre-release --no-dependencies
          PACKAGE_NAME=$(ls *.vsix)
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV

      - name: Publish Pre-release to VSCode Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          echo "ğŸš€ Publishing pre-release to VSCode Marketplace..."
          vsce publish --pre-release -p $VSCE_PAT --no-dependencies
          echo "âœ… Successfully published pre-release"

      - name: Create Pre-release on GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Pre-release v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸ§ª Pre-release v${{ steps.get_version.outputs.VERSION }}

            ì´ê²ƒì€ ì‚¬ì „ ë¦´ë¦¬ìŠ¤ ë²„ì „ì…ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.

            ### ì„¤ì¹˜ ë°©ë²•
            ```bash
            code --install-extension $(node -p "require('./package.json').publisher").rtems-qdp-builder@${{ steps.get_version.outputs.VERSION }}
            ```

            ë˜ëŠ” ì•„ë˜ VSIX íŒŒì¼ì„ ì§ì ‘ ì„¤ì¹˜í•˜ì„¸ìš”.
          files: ${{ env.PACKAGE_NAME }}
          draft: false
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
